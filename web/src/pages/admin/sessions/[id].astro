---
/**
 * Admin - Session Detail Page
 * 
 * Displays conversation timeline with LLM request metadata and prompt inspector.
 * Allows drilling into individual LLM requests for debugging.
 */

const { id } = Astro.params;
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';

// Server-side auth check - redirect to login if not authenticated
try {
    const response = await fetch(`${apiUrl}/api/admin/sessions?limit=1`, {
        credentials: 'include',
        headers: {
            'Cookie': Astro.request.headers.get('Cookie') || ''
        }
    });
    
    if (response.status === 401) {
        // Not authenticated - redirect to login
        return Astro.redirect('/admin/login');
    }
} catch (error) {
    // Network error or API down - redirect to login for safety
    return Astro.redirect('/admin/login');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session {id} | Admin | OpenThought</title>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Session Detail</h1>
                        <p class="mt-1 text-sm text-gray-500 font-mono">{id}</p>
                    </div>
                    <a
                        href="/admin/sessions"
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                    >
                        ‚Üê Back to Sessions
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <div id="session-detail" data-session-id={id}></div>
        </main>
    </div>

    <!-- Load Preact Component -->
    <script>
        import { h, render } from 'preact';
        import { SessionDetail } from '../../../components/admin/SessionDetail';

        const container = document.getElementById('session-detail');
        if (container) {
            const sessionId = container.getAttribute('data-session-id');
            const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';
            
            render(
                h(SessionDetail, { sessionId: sessionId || '', apiUrl }),
                container
            );
        }
    </script>
</body>
</html>

