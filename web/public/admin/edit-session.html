<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Session | Prompt Editor | OpenThought</title>
    
    <!-- HTMX v2.0.7 (latest) -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom scrollbar for text areas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Diff viewer styles */
        .diff-added {
            background-color: #d4f4dd;
            color: #22863a;
        }
        .diff-removed {
            background-color: #ffeef0;
            color: #cb2431;
        }
        
        /* Draggable module indicator */
        .dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header with Back Link -->
        <header class="mb-6">
            <a href="/admin/sessions.html" class="text-blue-600 hover:text-blue-800 text-sm">
                ‚Üê Back to Sessions
            </a>
            <h1 class="text-2xl font-bold text-gray-900 mt-2">Prompt Editor</h1>
            <p class="text-sm text-gray-500 mt-1">Test and iterate on prompt variations</p>
        </header>

        <!-- Top Controls: Session, Account, Agent, Model -->
        <div class="bg-white shadow-sm rounded-lg mb-6 p-6">
            <div class="grid grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Session</label>
                    <select id="session-select" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
                            hx-get="/api/admin/sessions/{SESSION_ID}/messages"
                            hx-trigger="change"
                            hx-target="#session-context-info"
                            hx-on::after-request="loadSessionContext(JSON.parse(event.detail.xhr.responseText))">
                        <option value="019a83e5-69a8-7130-80f4-d5aea9e38bd3">019a83e5-69a8-7130-80f4-d5aea9e38bd3</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                    <select class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="wyckoff">wyckoff</option>
                        <option value="agrofresh">agrofresh</option>
                        <option value="prepexcellence">prepexcellence</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Agent Instance</label>
                    <select class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="wyckoff_info_chat1">wyckoff_info_chat1</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                    <select class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="google/gemini-2.5-flash">google/gemini-2.5-flash</option>
                        <option value="deepseek/deepseek-chat-v3.1">deepseek/deepseek-chat-v3.1</option>
                        <option value="qwen/qwq-32b-preview">qwen/qwq-32b-preview</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium">
                        New Session
                    </button>
                </div>
            </div>
            
            <!-- Session Context Info (loaded via HTMX) -->
            <div id="session-context-info" class="mt-4 text-sm text-gray-600">
                <span class="inline-block mr-4">üìä Messages: <strong>4</strong></span>
                <span class="inline-block mr-4">üí∞ Total Cost: <strong>$0.0142</strong></span>
                <span class="inline-block">üïí Last Activity: <strong>2 hours ago</strong></span>
            </div>
        </div>

        <!-- Main Content: Split Pane (Editor | Preview/Response) -->
        <div class="grid grid-cols-2 gap-6">
            <!-- LEFT PANE: Prompt Editor -->
            <div class="space-y-6">
                
                <!-- Enhancement #7: Version History -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Version History</h2>
                        <button onclick="toggleVersionHistory()" class="text-sm text-blue-600 hover:text-blue-800">
                            Show History ‚ñº
                        </button>
                    </div>
                    <div id="version-history" class="hidden space-y-2">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded cursor-pointer hover:bg-blue-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-medium text-sm text-blue-900">Current (modified)</span>
                                    <p class="text-xs text-blue-700 mt-1">Unsaved changes</p>
                                </div>
                                <span class="text-xs text-blue-600">‚úèÔ∏è</span>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 border border-gray-200 rounded cursor-pointer hover:bg-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-medium text-sm">2025-12-01 22:00</span>
                                    <p class="text-xs text-gray-600 mt-1">"Added medical hints"</p>
                                </div>
                                <span class="text-xs text-green-600">‚úì</span>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 border border-gray-200 rounded cursor-pointer hover:bg-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-medium text-sm">2025-12-01 21:30</span>
                                    <p class="text-xs text-gray-600 mt-1">"Fixed tool selection"</p>
                                </div>
                                <span class="text-xs text-green-600">‚úì</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critical Rules Section -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            Critical Rules
                            <span class="ml-2 text-xs text-gray-500">(Position: 1)</span>
                        </label>
                        <div class="flex gap-2">
                            <!-- Enhancement #3: Template Library -->
                            <button onclick="showTemplateLibrary('critical_rules')" 
                                    class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                                üìö Library
                            </button>
                            <!-- Enhancement #4: Diff Viewer -->
                            <button onclick="toggleDiff('critical_rules')" 
                                    class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200">
                                üîç Diff
                            </button>
                        </div>
                    </div>
                    <select id="critical-rules-select" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm mb-2"
                            onchange="loadModuleContent('critical_rules', this.value)">
                        <option value="tool_selection_hints.md">tool_selection_hints.md</option>
                        <option value="tool_selection_strict.md">tool_selection_strict.md (variant)</option>
                    </select>
                    <!-- Enhancement #6: Token/Cost Estimates -->
                    <div class="mb-2 flex justify-between text-xs">
                        <span class="text-gray-600">
                            <span id="critical-rules-chars">4,435</span> / 8,000 chars 
                            (<span id="critical-rules-pct">55</span>%)
                        </span>
                        <span class="text-gray-600">
                            ~<span id="critical-rules-tokens">1,109</span> tokens 
                            (~$<span id="critical-rules-cost">0.0002</span>)
                        </span>
                    </div>
                    <textarea id="critical-rules-content" 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs font-mono"
                              rows="8"
                              oninput="updateCharCount('critical_rules', this.value)"
                              placeholder="Critical rules content...">When the user asks about departments, doctors, services, or contact information, you should ALWAYS use the search_directory tool first before responding.</textarea>
                    <div id="critical-rules-diff" class="hidden mt-2 p-3 bg-gray-50 border border-gray-200 rounded text-xs font-mono">
                        <!-- Diff content will be inserted here -->
                    </div>
                </div>

                <!-- Base Prompt Section -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            Base Prompt
                            <span class="ml-2 text-xs text-gray-500">(Position: 2)</span>
                        </label>
                        <div class="flex gap-2">
                            <button onclick="showTemplateLibrary('base_prompt')" 
                                    class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                                üìö Library
                            </button>
                            <button onclick="toggleDiff('base_prompt')" 
                                    class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200">
                                üîç Diff
                            </button>
                        </div>
                    </div>
                    <select class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm mb-2">
                        <option value="system_prompt.md">system_prompt.md</option>
                        <option value="system_prompt_concise.md">system_prompt_concise.md (variant)</option>
                    </select>
                    <div class="mb-2 flex justify-between text-xs">
                        <span class="text-gray-600">7,505 / 15,000 chars (50%)</span>
                        <span class="text-gray-600">~1,876 tokens (~$0.0004)</span>
                    </div>
                    <textarea class="w-full border border-gray-300 rounded-md px-3 py-2 text-xs font-mono"
                              rows="8"
                              placeholder="Base system prompt content...">You are an AI assistant for Wind River Hospital. Provide helpful, accurate information about hospital services, departments, and staff.</textarea>
                </div>

                <!-- Directory Schemas Section -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            Directory Schemas
                            <span class="ml-2 text-xs text-gray-500">(Auto-generated)</span>
                        </label>
                        <div class="flex gap-2">
                            <button class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                All
                            </button>
                            <button class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                                None
                            </button>
                            <button onclick="refreshDirectoryDocs()" 
                                    class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2 mb-2">
                        <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <input type="checkbox" checked onchange="updateSchemaSelection()" class="mr-2">
                            <span class="text-sm">medical_professional</span>
                            <span class="ml-auto text-xs text-gray-500">+1,813 chars</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <input type="checkbox" checked onchange="updateSchemaSelection()" class="mr-2">
                            <span class="text-sm">phone_directory</span>
                            <span class="ml-auto text-xs text-gray-500">+892 chars</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <input type="checkbox" onchange="updateSchemaSelection()" class="mr-2">
                            <span class="text-sm">FAQ</span>
                            <span class="ml-auto text-xs text-gray-500 italic">(New) +1,245 chars</span>
                        </label>
                    </div>
                    <div class="text-xs text-gray-600 bg-gray-50 p-3 rounded">
                        <strong>Preview:</strong> 2 schemas selected, ~2,705 chars, includes searchable fields for 124 medical professionals and 18 phone directory entries
                    </div>
                </div>

                <!-- Prompt Modules Section (with drag-to-reorder) -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            Prompt Modules
                            <span class="ml-2 text-xs text-gray-500">(Drag to reorder)</span>
                        </label>
                        <button class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                            ‚ûï Add Module
                        </button>
                    </div>
                    <div id="module-list" class="space-y-2">
                        <div class="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded cursor-move" draggable="true">
                            <span class="text-blue-700">‚ò∞</span>
                            <span class="text-sm font-medium flex-1">directory_selection_hints.md</span>
                            <span class="text-xs text-blue-600">Position: 3</span>
                            <button onclick="removeModule(this)" class="text-red-600 hover:text-red-800 text-xs">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Enhancement #5: Test Message Input -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <label class="block text-sm font-medium text-gray-900 mb-3">
                        Test Message (optional)
                    </label>
                    <textarea id="test-message" 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
                              rows="3"
                              placeholder="what is the number of the cardiology department?">what is the number of the cardiology department?</textarea>
                    <div class="mt-2 flex gap-2">
                        <button onclick="loadFromHistory()" 
                                class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            üìã Use from History
                        </button>
                        <button onclick="document.getElementById('test-message').value = ''" 
                                class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <div class="flex gap-3">
                        <button onclick="previewPrompt()" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                            üëÅÔ∏è Preview Prompt
                        </button>
                        <button onclick="executePrompt()" 
                                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium">
                            ‚ñ∂Ô∏è Execute Prompt
                        </button>
                    </div>
                    <div class="mt-3 flex gap-3">
                        <button onclick="saveAsVariant()" 
                                class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm">
                            üíæ Save as Variant
                        </button>
                        <button onclick="saveAsTestCase()" 
                                class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm">
                            üß™ Save as Test Case
                        </button>
                    </div>
                </div>

            </div>

            <!-- RIGHT PANE: Preview/Response -->
            <div class="space-y-6">
                
                <!-- Enhancement #2: Side-by-Side Comparison Tabs -->
                <div class="bg-white shadow-sm rounded-lg">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button onclick="switchTab('preview')" 
                                    id="tab-preview"
                                    class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
                                Preview
                            </button>
                            <button onclick="switchTab('response')" 
                                    id="tab-response"
                                    class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Response
                            </button>
                            <button onclick="switchTab('comparison')" 
                                    id="tab-comparison"
                                    class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                A/B Compare
                            </button>
                            <button onclick="switchTab('testing')" 
                                    id="tab-testing"
                                    class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Bulk Testing
                            </button>
                        </nav>
                    </div>

                    <!-- Enhancement #1: Visual Prompt Breakdown -->
                    <div id="content-preview" class="p-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold mb-2">Assembled Prompt</h3>
                            <div class="flex justify-between text-sm text-gray-600 bg-gray-50 p-3 rounded mb-4">
                                <div>
                                    <span class="font-medium">Total:</span> 15,406 characters
                                </div>
                                <div>
                                    <span class="font-medium">~3,852 tokens</span>
                                </div>
                                <div>
                                    <span class="font-medium">Est. Cost:</span> ~$0.0008
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible Sections -->
                        <div class="space-y-2">
                            <!-- Section 1: Critical Rules -->
                            <div class="border border-gray-200 rounded">
                                <button onclick="toggleSection('section-1')" 
                                        class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span id="section-1-arrow" class="text-gray-600">‚ñ∂</span>
                                        <span class="font-mono text-sm font-medium">1. critical_rules</span>
                                        <span class="text-xs text-gray-500">Source: tool_selection_hints.md</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-gray-600">4,435 chars</span>
                                        <button onclick="copySection('section-1-content'); event.stopPropagation();" 
                                                class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </button>
                                <div id="section-1" class="hidden px-4 py-3 bg-white border-t border-gray-200">
                                    <pre id="section-1-content" class="text-xs font-mono whitespace-pre-wrap text-gray-800 overflow-x-auto">When the user asks about departments, doctors, services, or contact information, you should ALWAYS use the search_directory tool first before responding...</pre>
                                </div>
                            </div>

                            <!-- Section 2: Base Prompt -->
                            <div class="border border-gray-200 rounded">
                                <button onclick="toggleSection('section-2')" 
                                        class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span id="section-2-arrow" class="text-gray-600">‚ñ∂</span>
                                        <span class="font-mono text-sm font-medium">2. base_prompt</span>
                                        <span class="text-xs text-gray-500">Source: system_prompt.md</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-gray-600">7,505 chars</span>
                                        <button onclick="copySection('section-2-content'); event.stopPropagation();" 
                                                class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </button>
                                <div id="section-2" class="hidden px-4 py-3 bg-white border-t border-gray-200">
                                    <pre id="section-2-content" class="text-xs font-mono whitespace-pre-wrap text-gray-800">You are an AI assistant for Wind River Hospital. Provide helpful, accurate information...</pre>
                                </div>
                            </div>

                            <!-- Section 3: Directory Docs (Auto-generated) -->
                            <div class="border border-gray-200 rounded">
                                <button onclick="toggleSection('section-3')" 
                                        class="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span id="section-3-arrow" class="text-blue-600">‚ñ∂</span>
                                        <span class="font-mono text-sm font-medium text-blue-900">3. directory_docs</span>
                                        <span class="text-xs text-blue-700">Source: auto-generated</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-blue-600">2,705 chars</span>
                                        <button onclick="alert('Regenerating directory docs...'); event.stopPropagation();" 
                                                class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            üîÑ Regenerate
                                        </button>
                                    </div>
                                </button>
                                <div id="section-3" class="hidden px-4 py-3 bg-white border-t border-blue-200">
                                    <div class="text-xs text-blue-700 mb-2 italic">
                                        Auto-generated from selected schemas: medical_professional (124 entries), phone_directory (18 entries)
                                    </div>
                                    <pre id="section-3-content" class="text-xs font-mono whitespace-pre-wrap text-gray-800">Available directories:

medical_professional: Search medical professionals by specialty, name, department, gender, or language
- 124 entries available
- Searchable fields: first_name, last_name, title, specialty, department, office_phone, languages

phone_directory: Search phone numbers by department or service
- 18 entries available
- Searchable fields: department_name, description, phone_number</pre>
                                </div>
                            </div>

                            <!-- Section 4: Prompt Module -->
                            <div class="border border-gray-200 rounded">
                                <button onclick="toggleSection('section-4')" 
                                        class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span id="section-4-arrow" class="text-gray-600">‚ñ∂</span>
                                        <span class="font-mono text-sm font-medium">4. directory_selection_hints</span>
                                        <span class="text-xs text-gray-500">Source: directory_selection_hints.md</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-gray-600">1,153 chars</span>
                                        <button onclick="copySection('section-4-content'); event.stopPropagation();" 
                                                class="text-xs px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </button>
                                <div id="section-4" class="hidden px-4 py-3 bg-white border-t border-gray-200">
                                    <pre id="section-4-content" class="text-xs font-mono whitespace-pre-wrap text-gray-800">When searching directories, use appropriate filters...</pre>
                                </div>
                            </div>
                        </div>

                        <!-- Full Prompt Button -->
                        <div class="mt-6">
                            <button onclick="showFullPrompt()" 
                                    class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm">
                                üìÑ View Full Assembled Prompt
                            </button>
                        </div>
                    </div>

                    <!-- Response Tab Content -->
                    <div id="content-response" class="p-6 hidden">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold mb-2">LLM Response</h3>
                            <div class="bg-gray-50 p-4 rounded text-sm">
                                <p class="text-gray-600 italic mb-2">Execute prompt to see response...</p>
                            </div>
                        </div>

                        <!-- Enhancement #6: Response Metadata -->
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="bg-purple-50 p-4 rounded border border-purple-200">
                                <h4 class="text-sm font-semibold text-purple-900 mb-3">LLM Metadata</h4>
                                <div class="space-y-2 text-sm">
                                    <div><span class="font-medium text-purple-700">Model:</span> <span class="text-gray-700">google/gemini-2.5-flash</span></div>
                                    <div><span class="font-medium text-purple-700">Input Tokens:</span> <span class="text-gray-700">3,852</span></div>
                                    <div><span class="font-medium text-purple-700">Output Tokens:</span> <span class="text-gray-700">101</span></div>
                                    <div><span class="font-medium text-purple-700">Total Tokens:</span> <span class="text-gray-700">3,953</span></div>
                                    <div><span class="font-medium text-purple-700">Latency:</span> <span class="text-gray-700">2,187ms</span></div>
                                    <div><span class="font-medium text-purple-700">Cost:</span> <span class="text-gray-700">$0.0008</span></div>
                                </div>
                            </div>

                            <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                                <h4 class="text-sm font-semibold text-yellow-900 mb-3">Tool Calls</h4>
                                <pre class="text-xs font-mono text-gray-800 overflow-x-auto whitespace-pre-wrap">{
  "args": {
    "list_name": "phone_directory",
    "filters": {"department_name": "Cardiology"}
  },
  "tool_name": "search_directory"
}</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Enhancement #2: A/B Comparison Tab Content -->
                    <div id="content-comparison" class="p-6 hidden">
                        <h3 class="text-lg font-semibold mb-4">Side-by-Side Comparison</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Version A -->
                            <div class="border border-gray-300 rounded">
                                <div class="bg-blue-50 p-3 border-b border-gray-300">
                                    <h4 class="font-semibold text-sm text-blue-900">Version A (Current)</h4>
                                </div>
                                <div class="p-4 bg-white">
                                    <div class="text-xs text-gray-600 space-y-1 mb-3">
                                        <div>Model: google/gemini-2.5-flash</div>
                                        <div>Tokens: 3,953</div>
                                        <div>Cost: $0.0008</div>
                                        <div>Latency: 2,187ms</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded text-xs">
                                        <p class="text-gray-800">I couldn't find a specific phone number for the Cardiology Department...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Version B -->
                            <div class="border border-gray-300 rounded">
                                <div class="bg-green-50 p-3 border-b border-gray-300">
                                    <h4 class="font-semibold text-sm text-green-900">Version B (Test)</h4>
                                </div>
                                <div class="p-4 bg-white">
                                    <div class="text-xs text-gray-600 space-y-1 mb-3">
                                        <div>Model: deepseek/deepseek-chat-v3.1</div>
                                        <div>Tokens: 4,120</div>
                                        <div>Cost: $0.0012</div>
                                        <div>Latency: 1,954ms</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded text-xs">
                                        <p class="text-gray-800">The Cardiology Department can be reached at 718-963-7272...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comparison Actions -->
                        <div class="mt-4 flex gap-3">
                            <button class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                                Make Version B Current
                            </button>
                            <button class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm">
                                Save Both as Variants
                            </button>
                        </div>
                    </div>

                    <!-- Enhancement #8: Bulk Testing Tab Content -->
                    <div id="content-testing" class="p-6 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Bulk Testing Suite</h3>
                            <button onclick="runTestSuite()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                ‚ñ∂Ô∏è Run All Tests
                            </button>
                        </div>

                        <div class="space-y-3">
                            <div class="p-4 bg-green-50 border border-green-200 rounded">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <span class="text-green-600 text-lg">‚úì</span>
                                        <div>
                                            <div class="font-medium text-sm text-green-900">Test Case 1: Find cardiologist</div>
                                            <div class="text-xs text-green-700 mt-1">Query: "Find me a cardiologist"</div>
                                            <div class="text-xs text-green-700">Expected: search_directory tool called</div>
                                            <div class="text-xs text-green-700">Result: ‚úì Correct tool selected</div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-green-600">142ms</span>
                                </div>
                            </div>

                            <div class="p-4 bg-green-50 border border-green-200 rounded">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <span class="text-green-600 text-lg">‚úì</span>
                                        <div>
                                            <div class="font-medium text-sm text-green-900">Test Case 2: Hospital hours</div>
                                            <div class="text-xs text-green-700 mt-1">Query: "What are the hospital hours?"</div>
                                            <div class="text-xs text-green-700">Expected: Direct response (no tool)</div>
                                            <div class="text-xs text-green-700">Result: ‚úì Correct response</div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-green-600">98ms</span>
                                </div>
                            </div>

                            <div class="p-4 bg-red-50 border border-red-200 rounded">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <span class="text-red-600 text-lg">‚úó</span>
                                        <div>
                                            <div class="font-medium text-sm text-red-900">Test Case 3: Emergency contact</div>
                                            <div class="text-xs text-red-700 mt-1">Query: "What's the emergency room number?"</div>
                                            <div class="text-xs text-red-700">Expected: search_directory tool called</div>
                                            <div class="text-xs text-red-700">Result: ‚úó No tool called (direct response)</div>
                                        </div>
                                    </div>
                                    <span class="text-xs text-red-600">156ms</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 bg-gray-100 p-4 rounded">
                            <div class="text-sm font-medium text-gray-900">Test Summary</div>
                            <div class="text-sm text-gray-600 mt-2">
                                <span class="text-green-600 font-medium">2 passed</span>, 
                                <span class="text-red-600 font-medium">1 failed</span>, 
                                <span class="text-gray-600">3 total</span>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>

    </div>

    <!-- Enhancement #3: Template Library Modal -->
    <div id="template-library-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Template Library</h3>
                <button onclick="closeTemplateLibrary()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-sm text-gray-700 mb-2">Tool Selection</h4>
                    <div class="space-y-2">
                        <button onclick="selectTemplate('tool_selection_hints.md')" 
                                class="w-full text-left p-3 border border-gray-200 rounded hover:bg-gray-50">
                            <div class="font-medium text-sm">tool_selection_hints.md</div>
                            <div class="text-xs text-gray-600">‚≠ê Current - Balanced guidance for tool selection</div>
                        </button>
                        <button onclick="selectTemplate('tool_selection_strict.md')" 
                                class="w-full text-left p-3 border border-gray-200 rounded hover:bg-gray-50">
                            <div class="font-medium text-sm">tool_selection_strict.md</div>
                            <div class="text-xs text-gray-600">Strict tool usage enforcement</div>
                        </button>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-sm text-gray-700 mb-2">System Prompts</h4>
                    <div class="space-y-2">
                        <button onclick="selectTemplate('system_prompt.md')" 
                                class="w-full text-left p-3 border border-gray-200 rounded hover:bg-gray-50">
                            <div class="font-medium text-sm">system_prompt.md</div>
                            <div class="text-xs text-gray-600">Default system prompt</div>
                        </button>
                        <button onclick="selectTemplate('system_prompt_concise.md')" 
                                class="w-full text-left p-3 border border-gray-200 rounded hover:bg-gray-50">
                            <div class="font-medium text-sm">system_prompt_concise.md</div>
                            <div class="text-xs text-gray-600">Shorter, more focused version</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all content
            document.getElementById('content-preview').classList.add('hidden');
            document.getElementById('content-response').classList.add('hidden');
            document.getElementById('content-comparison').classList.add('hidden');
            document.getElementById('content-testing').classList.add('hidden');
            
            // Reset all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected content
            document.getElementById('content-' + tabName).classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-600', 'text-blue-600');
        }

        // Toggle section in preview
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId + '-arrow');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                arrow.textContent = '‚ñº';
            } else {
                section.classList.add('hidden');
                arrow.textContent = '‚ñ∂';
            }
        }

        // Copy section content
        function copySection(contentId) {
            const content = document.getElementById(contentId).textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Content copied to clipboard!');
            });
        }

        // Show full prompt in modal
        function showFullPrompt() {
            alert('Full prompt modal would appear here with complete assembled prompt');
        }

        // Enhancement #7: Toggle version history
        function toggleVersionHistory() {
            const history = document.getElementById('version-history');
            history.classList.toggle('hidden');
        }

        // Enhancement #4: Toggle diff viewer
        function toggleDiff(moduleId) {
            const diffDiv = document.getElementById(moduleId + '-diff');
            if (diffDiv.classList.contains('hidden')) {
                diffDiv.classList.remove('hidden');
                diffDiv.innerHTML = `
                    <div class="mb-2 text-xs font-semibold">Changes from original:</div>
                    <div class="diff-removed">- Old line: use the tool when appropriate</div>
                    <div class="diff-added">+ New line: ALWAYS use the search_directory tool first</div>
                    <div>  Unchanged line: before responding.</div>
                `;
            } else {
                diffDiv.classList.add('hidden');
            }
        }

        // Enhancement #3: Show template library
        function showTemplateLibrary(moduleId) {
            document.getElementById('template-library-modal').classList.remove('hidden');
        }

        function closeTemplateLibrary() {
            document.getElementById('template-library-modal').classList.add('hidden');
        }

        function selectTemplate(templateName) {
            alert('Loading template: ' + templateName);
            closeTemplateLibrary();
        }

        // Enhancement #6: Update character count
        function updateCharCount(moduleId, content) {
            const charCount = content.length;
            const tokenCount = Math.ceil(charCount / 4); // Rough estimate
            const cost = (tokenCount / 1000000) * 0.15; // Rough estimate
            
            document.getElementById(moduleId + '-chars').textContent = charCount.toLocaleString();
            document.getElementById(moduleId + '-tokens').textContent = tokenCount.toLocaleString();
            document.getElementById(moduleId + '-cost').textContent = cost.toFixed(4);
            
            const pct = Math.min(100, (charCount / 8000) * 100);
            document.getElementById(moduleId + '-pct').textContent = pct.toFixed(0);
        }

        // Load module content
        function loadModuleContent(moduleId, filename) {
            console.log('Loading', filename, 'for', moduleId);
            // In real implementation, would fetch content from backend
        }

        // Schema selection
        function updateSchemaSelection() {
            console.log('Schema selection updated');
            // In real implementation, would recalculate directory docs
        }

        // Refresh directory docs
        function refreshDirectoryDocs() {
            alert('Refreshing directory documentation from database...');
        }

        // Load from history
        function loadFromHistory() {
            const messages = [
                'what is the number of the cardiology department?',
                'Find me a cardiologist who speaks Spanish',
                "What are the hospital's visiting hours?"
            ];
            const selected = prompt('Select a message:\n' + messages.map((m, i) => `${i+1}. ${m}`).join('\n'));
            if (selected) {
                document.getElementById('test-message').value = messages[parseInt(selected) - 1] || '';
            }
        }

        // Remove module
        function removeModule(button) {
            button.closest('div[draggable]').remove();
        }

        // Preview prompt
        function previewPrompt() {
            alert('Assembling prompt preview...');
            switchTab('preview');
        }

        // Execute prompt
        function executePrompt() {
            if (confirm('Execute prompt and call LLM? This will incur costs.')) {
                alert('Executing prompt...');
                switchTab('response');
                // In real implementation, would call backend API
            }
        }

        // Save as variant
        function saveAsVariant() {
            const name = prompt('Enter variant name:');
            if (name) {
                alert('Saved as variant: ' + name);
            }
        }

        // Save as test case
        function saveAsTestCase() {
            const name = prompt('Enter test case name:');
            if (name) {
                alert('Saved as test case: ' + name);
            }
        }

        // Run test suite
        function runTestSuite() {
            alert('Running all tests...');
            // In real implementation, would execute all test cases
        }

        // Load session context
        function loadSessionContext(data) {
            console.log('Session context loaded:', data);
            // In real implementation, would populate session info
        }

        // Initialize drag and drop for modules
        document.addEventListener('DOMContentLoaded', function() {
            const moduleList = document.getElementById('module-list');
            if (moduleList) {
                moduleList.addEventListener('dragstart', function(e) {
                    e.target.classList.add('dragging');
                });
                
                moduleList.addEventListener('dragend', function(e) {
                    e.target.classList.remove('dragging');
                });
            }
        });
    </script>
</body>
</html>

