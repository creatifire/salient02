<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Detail | Admin | OpenThought</title>
    
    <!-- HTMX v2.0.7 (latest) -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header with back link -->
        <header class="mb-6">
            <a href="/admin/sessions.html" class="text-blue-600 hover:text-blue-800 text-sm">
                ‚Üê Back to Sessions
            </a>
            <h1 class="text-2xl font-bold text-gray-900 mt-2">Session Detail</h1>
            <p id="session-id" class="text-sm text-gray-500 font-mono mt-1"></p>
        </header>

        <!-- Messages Timeline -->
        <div id="messages-container"
             hx-get="/api/admin/sessions/{SESSION_ID}/messages"
             hx-trigger="load"
             hx-on::after-request="renderMessages(JSON.parse(event.detail.xhr.responseText))">
            <div class="p-6 text-center text-gray-500">
                <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading messages...
            </div>
        </div>
    </div>

    <script>
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id');
        
        if (!sessionId) {
            document.body.innerHTML = '<div class="max-w-7xl mx-auto px-4 py-6"><p class="text-red-600 p-6 bg-white rounded-lg">No session ID provided</p></div>';
        } else {
            document.getElementById('session-id').textContent = sessionId;
            
            // Set the HTMX URL with the actual session ID
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.setAttribute('hx-get', `/api/admin/sessions/${sessionId}/messages`);
            
            // CRITICAL: Tell HTMX to process the newly set attribute!
            htmx.process(messagesContainer);
        }
        
        // Render messages from JSON response (called by HTMX event handler)
        function renderMessages(data) {
            const container = document.getElementById('messages-container');
            
            if (!data.messages || data.messages.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg p-6 text-gray-500">No messages in this session</div>';
                return;
            }
            
            const html = data.messages.map(msg => {
                const isUser = msg.role === 'human';
                const bgColor = isUser ? 'bg-blue-50' : 'bg-white';
                const borderColor = isUser ? 'border-blue-200' : 'border-gray-200';
                
                return `
                    <div class="mb-4 p-4 rounded-lg border ${borderColor} ${bgColor}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-sm ${isUser ? 'text-blue-700' : 'text-gray-700'}">
                                ${isUser ? 'üë§ User' : 'ü§ñ Assistant'}
                            </span>
                            <span class="text-xs text-gray-500">
                                ${new Date(msg.created_at).toLocaleString()}
                            </span>
                        </div>
                        <p class="text-gray-900 whitespace-pre-wrap">${msg.content}</p>
                        
                        ${isUser && msg.llm_request_id ? `
                            <div class="mt-3 flex gap-2">
                                <button onclick="toggleBreakdown('${msg.llm_request_id}')"
                                        class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md text-sm hover:bg-gray-300">
                                    üîç View Prompt Breakdown
                                </button>
                                <button onclick="toggleFullPrompt('${msg.llm_request_id}')"
                                        class="px-3 py-1 bg-blue-200 text-blue-800 rounded-md text-sm hover:bg-blue-300">
                                    üìÑ View Full Assembled Prompt
                                </button>
                            </div>
                            <div id="breakdown-${msg.llm_request_id}" class="hidden mt-3 p-3 bg-gray-50 rounded text-sm"></div>
                            <div id="full-prompt-${msg.llm_request_id}" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-sm"></div>
                        ` : ''}
                        
                        ${!isUser && msg.meta && (msg.meta.model || msg.meta.input_tokens) ? `
                            <div class="mt-3 p-3 bg-purple-50 rounded border border-purple-200">
                                <p class="text-xs font-semibold text-purple-800 mb-2">üìä LLM Metadata:</p>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                    <div><span class="font-medium text-purple-700">Model:</span> <span class="text-gray-700">${msg.meta.model || 'N/A'}</span></div>
                                    <div><span class="font-medium text-purple-700">Latency:</span> <span class="text-gray-700">${msg.meta.latency_ms ? msg.meta.latency_ms + 'ms' : 'N/A'}</span></div>
                                    <div><span class="font-medium text-purple-700">Input Tokens:</span> <span class="text-gray-700">${msg.meta.input_tokens || 0}</span></div>
                                    <div><span class="font-medium text-purple-700">Output Tokens:</span> <span class="text-gray-700">${msg.meta.output_tokens || 0}</span></div>
                                    <div><span class="font-medium text-purple-700">Total Tokens:</span> <span class="text-gray-700">${(msg.meta.input_tokens || 0) + (msg.meta.output_tokens || 0)}</span></div>
                                    <div><span class="font-medium text-purple-700">Cost:</span> <span class="text-gray-700">$${msg.meta.cost ? msg.meta.cost.toFixed(4) : '0.0000'}</span></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!isUser && msg.meta && (msg.meta.confidence_score || msg.meta.reasoning_chain) ? `
                            <div class="mt-3 p-3 bg-green-50 rounded border border-green-200">
                                <p class="text-xs font-semibold text-green-800 mb-2">‚ú® Response Quality:</p>
                                <div class="space-y-2 text-xs">
                                    ${msg.meta.confidence_score ? `
                                        <div><span class="font-medium text-green-700">Confidence:</span> 
                                        <span class="text-gray-700">${(msg.meta.confidence_score * 100).toFixed(1)}%</span></div>
                                    ` : ''}
                                    ${msg.meta.reasoning_chain ? `
                                        <div class="mt-2">
                                            <span class="font-medium text-green-700">Reasoning Chain:</span>
                                            <pre class="mt-1 text-xs text-gray-700 overflow-x-auto whitespace-pre-wrap">${JSON.stringify(msg.meta.reasoning_chain, null, 2)}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${msg.meta?.tool_calls ? `
                            <div class="mt-3 p-3 bg-yellow-50 rounded border border-yellow-200">
                                <p class="text-xs font-semibold text-yellow-800 mb-2">üõ†Ô∏è Tool Calls:</p>
                                <pre class="text-xs text-gray-700 overflow-x-auto">${JSON.stringify(msg.meta.tool_calls, null, 2)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Tell HTMX to process the newly added elements with hx-* attributes
            htmx.process(container);
        }
        
        // Toggle prompt breakdown display
        async function toggleBreakdown(requestId) {
            const breakdownDiv = document.getElementById(`breakdown-${requestId}`);
            
            // If already visible, just hide it
            if (!breakdownDiv.classList.contains('hidden')) {
                breakdownDiv.classList.add('hidden');
                return;
            }
            
            // If already loaded, just show it
            if (breakdownDiv.innerHTML && breakdownDiv.innerHTML.includes('Prompt Sections')) {
                breakdownDiv.classList.remove('hidden');
                return;
            }
            
            // Fetch and display the breakdown
            try {
                const response = await fetch(`/api/admin/llm-requests/${requestId}`);
                const data = await response.json();
                const breakdown = data.prompt_breakdown;
                
                if (!breakdown || !breakdown.sections || breakdown.sections.length === 0) {
                    breakdownDiv.innerHTML = '<p class="text-gray-500">No breakdown available</p>';
                } else {
                    let html = `
                        <h4 class="font-semibold mb-3">
                            Prompt Sections: ${breakdown.sections.length} modules, 
                            ${breakdown.total_char_count.toLocaleString()} characters total
                        </h4>
                    `;
                    
                    breakdown.sections.forEach((section, index) => {
                        const sectionId = `section-${requestId}-${index}`;
                        const hasContent = section.content && section.content.trim().length > 0;
                        const isNested = section.parent_position !== undefined;
                        const indentClass = isNested ? 'ml-6 border-l-2 border-gray-300 pl-3' : '';
                        
                        html += `
                            <div class="mb-2 ${indentClass}">
                                <!-- Clickable Header -->
                                <button 
                                    class="w-full text-left px-3 py-2 bg-gray-100 hover:bg-gray-200 
                                           font-medium flex justify-between items-center rounded ${!hasContent ? 'opacity-50 cursor-not-allowed' : ''}"
                                    onclick="toggleSection('${sectionId}', this)"
                                    ${!hasContent ? 'disabled' : ''}>
                                    <span class="flex items-center gap-2">
                                        <span class="arrow text-gray-600">${hasContent ? '‚ñ∂' : '‚óã'}</span> 
                                        <span class="font-mono text-sm">${section.name}</span>
                                    </span>
                                    <span class="text-xs text-gray-600">
                                        (${section.position}) ${section.characters.toLocaleString()} chars
                                    </span>
                                </button>
                                
                                <!-- Content (expandable) -->
                                ${hasContent ? `
                                    <div id="${sectionId}" class="hidden mt-2">
                                        <!-- Metadata bar -->
                                        <div class="px-3 py-1 text-xs text-gray-600 bg-gray-100 rounded-t border border-gray-300">
                                            Source: ${section.source || 'N/A'}
                                            ${section.metadata && section.metadata.entry_count ? 
                                                ` | ${section.metadata.entry_count} ${section.metadata.entry_type || 'entries'}` : ''}
                                        </div>
                                        <!-- Content box -->
                                        <div class="px-3 py-2 bg-white border-x border-b border-gray-300 rounded-b">
                                            <pre class="text-xs whitespace-pre-wrap font-mono text-gray-800 
                                                       border-l-4 border-blue-400 pl-3 max-h-96 overflow-y-auto">${escapeHtml(section.content)}</pre>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="px-3 py-2 text-xs text-gray-500 italic">
                                        Content not captured for this section
                                    </div>
                                `}
                            </div>
                        `;
                    });
                    
                    breakdownDiv.innerHTML = html;
                }
                
                breakdownDiv.classList.remove('hidden');
            } catch (error) {
                breakdownDiv.innerHTML = `<p class="text-red-600">Error loading breakdown: ${error.message}</p>`;
                breakdownDiv.classList.remove('hidden');
            }
        }
        
        // Toggle section content visibility
        function toggleSection(sectionId, buttonEl) {
            const contentDiv = document.getElementById(sectionId);
            const arrow = buttonEl.querySelector('.arrow');
            
            if (contentDiv.classList.contains('hidden')) {
                contentDiv.classList.remove('hidden');
                arrow.textContent = '‚ñº';
            } else {
                contentDiv.classList.add('hidden');
                arrow.textContent = '‚ñ∂';
            }
        }
        
        // Toggle full assembled prompt display
        async function toggleFullPrompt(requestId) {
            const fullPromptDiv = document.getElementById(`full-prompt-${requestId}`);
            
            // If already visible, just hide it
            if (!fullPromptDiv.classList.contains('hidden')) {
                fullPromptDiv.classList.add('hidden');
                return;
            }
            
            // If already loaded, just show it
            if (fullPromptDiv.innerHTML && fullPromptDiv.innerHTML.includes('Assembled Prompt')) {
                fullPromptDiv.classList.remove('hidden');
                return;
            }
            
            // Fetch and display the full assembled prompt
            try {
                const response = await fetch(`/api/admin/llm-requests/${requestId}`);
                const data = await response.json();
                const assembledPrompt = data.assembled_prompt;
                
                if (assembledPrompt && assembledPrompt.trim().length > 0) {
                    const charCount = assembledPrompt.length;
                    const lineCount = assembledPrompt.split('\n').length;
                    
                    fullPromptDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-blue-300">
                            <h4 class="font-semibold text-blue-900 flex items-center gap-2">
                                <span>üìÑ</span>
                                Full Assembled Prompt
                            </h4>
                            <div class="flex gap-3 text-xs text-blue-700">
                                <span class="bg-blue-100 px-2 py-1 rounded">${charCount.toLocaleString()} characters</span>
                                <span class="bg-blue-100 px-2 py-1 rounded">${lineCount.toLocaleString()} lines</span>
                                <button onclick="copyToClipboard('full-prompt-content-${requestId}', event)" 
                                        class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">
                                    üìã Copy
                                </button>
                            </div>
                        </div>
                        <div class="bg-white border border-blue-200 rounded p-3 max-h-96 overflow-y-auto">
                            <pre id="full-prompt-content-${requestId}" 
                                 class="text-xs whitespace-pre-wrap font-mono text-gray-800 leading-relaxed">${escapeHtml(assembledPrompt)}</pre>
                        </div>
                        <p class="mt-2 text-xs text-blue-600 italic">
                            üí° This is the exact system prompt sent to the LLM (before chat history)
                        </p>
                    `;
                } else {
                    fullPromptDiv.innerHTML = `
                        <p class="text-gray-500 italic">
                            ‚ö†Ô∏è Assembled prompt not available for this request (captured in future requests only)
                        </p>
                    `;
                }
                
                fullPromptDiv.classList.remove('hidden');
            } catch (error) {
                fullPromptDiv.innerHTML = `<p class="text-red-600">Error loading assembled prompt: ${error.message}</p>`;
                fullPromptDiv.classList.remove('hidden');
            }
        }
        
        // Copy to clipboard utility
        function copyToClipboard(elementId, event) {
            const element = document.getElementById(elementId);
            if (element) {
                const text = element.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    // Show temporary success message
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Copied!';
                    btn.classList.add('bg-green-600');
                    btn.classList.remove('bg-blue-600');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.add('bg-blue-600');
                        btn.classList.remove('bg-green-600');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy to clipboard');
                });
            }
        }
        
        // HTML escape utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

