<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Detail | Admin | OpenThought</title>
    
    <!-- HTMX v2.0.7 (latest) -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header with back link -->
        <header class="mb-6">
            <a href="/admin/sessions.html" class="text-blue-600 hover:text-blue-800 text-sm">
                ‚Üê Back to Sessions
            </a>
            <h1 class="text-2xl font-bold text-gray-900 mt-2">Session Detail</h1>
            <p id="session-id" class="text-sm text-gray-500 font-mono mt-1"></p>
        </header>

        <!-- Messages Timeline -->
        <div id="messages-container"
             hx-get="/api/admin/sessions/{SESSION_ID}/messages"
             hx-trigger="load"
             hx-on::after-request="renderMessages(JSON.parse(event.detail.xhr.responseText))">
            <div class="p-6 text-center text-gray-500">
                <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading messages...
            </div>
        </div>
    </div>

    <script>
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id');
        
        if (!sessionId) {
            document.body.innerHTML = '<div class="max-w-7xl mx-auto px-4 py-6"><p class="text-red-600 p-6 bg-white rounded-lg">No session ID provided</p></div>';
        } else {
            document.getElementById('session-id').textContent = sessionId;
            
            // Set the HTMX URL with the actual session ID
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.setAttribute('hx-get', `/api/admin/sessions/${sessionId}/messages`);
            
            // CRITICAL: Tell HTMX to process the newly set attribute!
            htmx.process(messagesContainer);
        }
        
        // Render messages from JSON response (called by HTMX event handler)
        function renderMessages(data) {
            const container = document.getElementById('messages-container');
            
            if (!data.messages || data.messages.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg p-6 text-gray-500">No messages in this session</div>';
                return;
            }
            
            const html = data.messages.map(msg => {
                const isUser = msg.role === 'user';
                const bgColor = isUser ? 'bg-blue-50' : 'bg-white';
                const borderColor = isUser ? 'border-blue-200' : 'border-gray-200';
                
                return `
                    <div class="mb-4 p-4 rounded-lg border ${borderColor} ${bgColor}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-sm ${isUser ? 'text-blue-700' : 'text-gray-700'}">
                                ${isUser ? 'üë§ User' : 'ü§ñ Assistant'}
                            </span>
                            <span class="text-xs text-gray-500">
                                ${new Date(msg.created_at).toLocaleString()}
                            </span>
                        </div>
                        <p class="text-gray-900 whitespace-pre-wrap">${msg.content}</p>
                        
                        ${msg.llm_request_id ? `
                            <button hx-get="/api/admin/llm-requests/${msg.llm_request_id}"
                                    hx-trigger="click"
                                    hx-swap="none"
                                    hx-on::after-request="renderPromptBreakdown(event.detail.xhr.responseText, '${msg.llm_request_id}')"
                                    class="mt-3 text-sm text-blue-600 hover:text-blue-800">
                                üîç View Prompt Breakdown
                            </button>
                            <div id="breakdown-${msg.llm_request_id}" class="hidden mt-3 p-3 bg-gray-50 rounded text-sm"></div>
                        ` : ''}
                        
                        ${msg.meta?.tool_calls ? `
                            <div class="mt-3 p-3 bg-yellow-50 rounded border border-yellow-200">
                                <p class="text-xs font-semibold text-yellow-800 mb-2">Tool Calls:</p>
                                <pre class="text-xs text-gray-700 overflow-x-auto">${JSON.stringify(msg.meta.tool_calls, null, 2)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Tell HTMX to process the newly added elements with hx-* attributes
            htmx.process(container);
        }
        
        // Render prompt breakdown from JSON response (called by HTMX event handler)
        function renderPromptBreakdown(responseText, requestId) {
            const breakdownDiv = document.getElementById(`breakdown-${requestId}`);
            
            // Toggle visibility if already loaded
            if (!breakdownDiv.classList.contains('hidden') && breakdownDiv.innerHTML.includes('Prompt Sections')) {
                breakdownDiv.classList.add('hidden');
                return;
            }
            
            const data = JSON.parse(responseText);
            const breakdown = data.prompt_breakdown;
            
            if (!breakdown) {
                breakdownDiv.innerHTML = '<p class="text-gray-500">No breakdown available</p>';
                breakdownDiv.classList.remove('hidden');
                return;
            }
            
            const html = `
                <p class="font-semibold mb-2">Prompt Sections (${breakdown.total_char_count.toLocaleString()} chars):</p>
                <ul class="space-y-2">
                    ${breakdown.sections.map(section => `
                        <li class="flex justify-between items-center">
                            <span class="font-mono text-xs">${section.position}. ${section.name}</span>
                            <span class="text-gray-600">${section.char_count.toLocaleString()} chars</span>
                        </li>
                    `).join('')}
                </ul>
            `;
            
            breakdownDiv.innerHTML = html;
            breakdownDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>

