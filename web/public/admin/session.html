<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Detail | Admin | OpenThought</title>
    
    <!-- HTMX v2.0.7 (latest) -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header with back link -->
        <header class="mb-6">
            <a href="/admin/sessions.html" class="text-blue-600 hover:text-blue-800 text-sm">
                ‚Üê Back to Sessions
            </a>
            <h1 class="text-2xl font-bold text-gray-900 mt-2">Session Detail</h1>
            <p id="session-id" class="text-sm text-gray-500 font-mono mt-1"></p>
        </header>

        <!-- Messages Timeline -->
        <div id="messages-container"
             hx-get="/api/admin/sessions/{SESSION_ID}/messages"
             hx-trigger="load"
             hx-on::after-request="renderMessages(JSON.parse(event.detail.xhr.responseText))">
            <div class="p-6 text-center text-gray-500">
                <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading messages...
            </div>
        </div>
    </div>

    <script>
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id');
        
        if (!sessionId) {
            document.body.innerHTML = '<div class="max-w-7xl mx-auto px-4 py-6"><p class="text-red-600 p-6 bg-white rounded-lg">No session ID provided</p></div>';
        } else {
            document.getElementById('session-id').textContent = sessionId;
            
            // Set the HTMX URL with the actual session ID
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.setAttribute('hx-get', `/api/admin/sessions/${sessionId}/messages`);
            
            // CRITICAL: Tell HTMX to process the newly set attribute!
            htmx.process(messagesContainer);
        }
        
        // Render messages from JSON response (called by HTMX event handler)
        function renderMessages(data) {
            const container = document.getElementById('messages-container');
            
            if (!data.messages || data.messages.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg p-6 text-gray-500">No messages in this session</div>';
                return;
            }
            
            const html = data.messages.map(msg => {
                const isUser = msg.role === 'human';
                const bgColor = isUser ? 'bg-blue-50' : 'bg-white';
                const borderColor = isUser ? 'border-blue-200' : 'border-gray-200';
                
                return `
                    <div class="mb-4 p-4 rounded-lg border ${borderColor} ${bgColor}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-sm ${isUser ? 'text-blue-700' : 'text-gray-700'}">
                                ${isUser ? 'üë§ User' : 'ü§ñ Assistant'}
                            </span>
                            <span class="text-xs text-gray-500">
                                ${new Date(msg.created_at).toLocaleString()}
                            </span>
                        </div>
                        <p class="text-gray-900 whitespace-pre-wrap">${msg.content}</p>
                        
                        ${isUser && msg.llm_request_id ? `
                            <button onclick="toggleBreakdown('${msg.llm_request_id}')"
                                    class="mt-3 text-sm text-blue-600 hover:text-blue-800 cursor-pointer">
                                üîç View Prompt Breakdown
                            </button>
                            <div id="breakdown-${msg.llm_request_id}" class="hidden mt-3 p-3 bg-gray-50 rounded text-sm"></div>
                        ` : ''}
                        
                        ${!isUser && msg.meta && (msg.meta.model || msg.meta.input_tokens) ? `
                            <div class="mt-3 p-3 bg-purple-50 rounded border border-purple-200">
                                <p class="text-xs font-semibold text-purple-800 mb-2">üìä LLM Metadata:</p>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                    <div><span class="font-medium text-purple-700">Model:</span> <span class="text-gray-700">${msg.meta.model || 'N/A'}</span></div>
                                    <div><span class="font-medium text-purple-700">Latency:</span> <span class="text-gray-700">${msg.meta.latency_ms ? msg.meta.latency_ms + 'ms' : 'N/A'}</span></div>
                                    <div><span class="font-medium text-purple-700">Input Tokens:</span> <span class="text-gray-700">${msg.meta.input_tokens || 0}</span></div>
                                    <div><span class="font-medium text-purple-700">Output Tokens:</span> <span class="text-gray-700">${msg.meta.output_tokens || 0}</span></div>
                                    <div><span class="font-medium text-purple-700">Total Tokens:</span> <span class="text-gray-700">${(msg.meta.input_tokens || 0) + (msg.meta.output_tokens || 0)}</span></div>
                                    <div><span class="font-medium text-purple-700">Cost:</span> <span class="text-gray-700">$${msg.meta.cost ? msg.meta.cost.toFixed(4) : '0.0000'}</span></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!isUser && msg.meta && (msg.meta.confidence_score || msg.meta.reasoning_chain) ? `
                            <div class="mt-3 p-3 bg-green-50 rounded border border-green-200">
                                <p class="text-xs font-semibold text-green-800 mb-2">‚ú® Response Quality:</p>
                                <div class="space-y-2 text-xs">
                                    ${msg.meta.confidence_score ? `
                                        <div><span class="font-medium text-green-700">Confidence:</span> 
                                        <span class="text-gray-700">${(msg.meta.confidence_score * 100).toFixed(1)}%</span></div>
                                    ` : ''}
                                    ${msg.meta.reasoning_chain ? `
                                        <div class="mt-2">
                                            <span class="font-medium text-green-700">Reasoning Chain:</span>
                                            <pre class="mt-1 text-xs text-gray-700 overflow-x-auto whitespace-pre-wrap">${JSON.stringify(msg.meta.reasoning_chain, null, 2)}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${msg.meta?.tool_calls ? `
                            <div class="mt-3 p-3 bg-yellow-50 rounded border border-yellow-200">
                                <p class="text-xs font-semibold text-yellow-800 mb-2">üõ†Ô∏è Tool Calls:</p>
                                <pre class="text-xs text-gray-700 overflow-x-auto">${JSON.stringify(msg.meta.tool_calls, null, 2)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Tell HTMX to process the newly added elements with hx-* attributes
            htmx.process(container);
        }
        
        // Toggle prompt breakdown visibility
        async function toggleBreakdown(requestId) {
            const breakdownDiv = document.getElementById(`breakdown-${requestId}`);
            
            // If already visible, just hide it
            if (!breakdownDiv.classList.contains('hidden')) {
                breakdownDiv.classList.add('hidden');
                return;
            }
            
            // If already loaded, just show it
            if (breakdownDiv.innerHTML && breakdownDiv.innerHTML.includes('Prompt Sections')) {
                breakdownDiv.classList.remove('hidden');
                return;
            }
            
            // Fetch and display the breakdown
            try {
                const response = await fetch(`/api/admin/llm-requests/${requestId}`);
                const data = await response.json();
                const breakdown = data.prompt_breakdown;
                
                if (!breakdown) {
                    breakdownDiv.innerHTML = '<p class="text-gray-500">No breakdown available</p>';
                } else {
                    breakdownDiv.innerHTML = `
                        <p class="font-semibold mb-2">Prompt Sections (${breakdown.total_char_count.toLocaleString()} chars):</p>
                        <ul class="space-y-2">
                            ${breakdown.sections.map(section => `
                                <li class="border-l-2 border-gray-300 pl-3 py-1">
                                    <div class="font-mono text-xs font-semibold">${section.position}. ${section.name}</div>
                                    <div class="text-xs text-gray-600">Source: ${section.source} | ${section.char_count.toLocaleString()} chars</div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }
                
                breakdownDiv.classList.remove('hidden');
            } catch (error) {
                breakdownDiv.innerHTML = `<p class="text-red-600">Error loading breakdown: ${error.message}</p>`;
                breakdownDiv.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>

