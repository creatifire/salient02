<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Standalone HTMX Chat (Plain)</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <style>
      body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:1rem; }
      .container{ max-width: 960px; margin: 0 auto; }
      .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
      .skip-link:focus{ position:static; width:auto; height:auto; padding:.25rem .5rem; background:#111; color:#fff; border-radius:6px; }
      .chat{ border:1px solid #eee; border-radius:8px; padding:.5rem; height: 320px; overflow:auto; background:#fff; display:flex; flex-direction:column; gap:.4rem; }
      .msg{ position:relative; padding:.6rem .8rem; border-radius:6px; max-width:85%; word-wrap:break-word; }
      .msg.user{ background:#eef6ff; align-self:flex-end; margin-left:auto; }
      .msg.bot{ background:#fffbe6; align-self:flex-start; margin-right:auto; }
      .content{ white-space:pre-wrap; }
      .copy{ position:absolute; bottom:6px; right:6px; background:rgba(255,255,255,.9); border:1px solid #ddd; border-radius:6px; padding:4px; width:22px; height:22px; display:flex; align-items:center; justify-content:center; opacity:.2; transition:opacity .15s ease, transform .1s ease; cursor:pointer; }
      .copy img{ width:14px; height:14px; display:block; }
      .msg.bot:hover .copy, .copy:focus{ opacity:1; }
      .copy:active{ transform: scale(.96); }
      .copy[disabled]{ opacity:.2 !important; pointer-events:none; cursor:not-allowed; }
      .row{ display:flex; align-items:center; gap:.5rem; margin-top:.5rem; }
      .btn{ padding:.45rem .7rem; border:1px solid #ccc; border-radius:6px; background:#f6f6f6; }
      .btn.primary{ background:#108D43; color:#fff; border-color:#108D43; }
      .btn:focus-visible, .copy:focus-visible, .textarea:focus-visible{ outline:2px solid #0ea5e9; outline-offset:2px; }
      .btn:disabled{ opacity:.6; cursor:not-allowed; }
      .textarea{ width:100%; min-height:6rem; padding:.5rem; border:1px solid #ddd; border-radius:6px; margin-top:.5rem; }
      .hint{ font-size:.85rem; color:#666; display:none; }
      .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="#chat-main" class="skip-link">Skip to chat</a>
      <main id="chat-main" role="main">
        <h1>Standalone HTMX Chat (Plain)</h1>
        <div class="chat" aria-live="polite"></div>
        <label for="msg" class="sr-only">Message</label>
        <textarea id="msg" class="textarea" placeholder="Type your message… (Ctrl/Cmd+Enter to send)" aria-label="Message input"></textarea>
      </main>
      <div class="row">
        <button id="send" class="btn primary" type="button">Send</button>
        <button id="clear" class="btn" type="button">Clear</button>
        <span id="hint" class="hint">Receiving…</span>
      </div>
    </div>
    <script>
      const chat = document.querySelector('.chat');
      const msg = document.getElementById('msg');
      const sendBtn = document.getElementById('send');
      const clearBtn = document.getElementById('clear');
      const hint = document.getElementById('hint');

      let activeSSE = null; let activeBotDiv = null; let accumulated = ''; let busy=false;
      function addCopy(container){
        const b = document.createElement('button');
        b.className='copy'; b.type='button'; b.setAttribute('aria-label','Copy message'); b.title='Copy';
        const img=document.createElement('img'); img.src='/widget/chat-copy.svg'; img.alt=''; b.appendChild(img);
        b.disabled = busy;
        b.addEventListener('click', async ()=>{
          const raw = container.dataset.raw || container.textContent || '';
          try{ await navigator.clipboard.writeText(raw); }catch{
            const ta=document.createElement('textarea'); ta.value=raw; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand && document.execCommand('copy'); ta.remove();
          }
        });
        container.appendChild(b);
      }
      function append(role, text){
        const d=document.createElement('div'); d.className='msg '+role;
        const c=document.createElement('div'); c.className='content'; c.textContent=text||''; d.appendChild(c);
        if (role==='bot') addCopy(d);
        chat.appendChild(d); chat.scrollTop=chat.scrollHeight; return d;
      }
      function setBusy(v){ busy=v; sendBtn.disabled=v; clearBtn.disabled=v; hint.style.display=v?'inline':'none'; chat.querySelectorAll('.copy').forEach(b=>{ b.disabled = v; }); }
      clearBtn.addEventListener('click', ()=>{ chat.innerHTML=''; });

      // Debounce helper to mirror backend page behavior
      function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), ms); } }
      const debouncedNoop = debounce(()=>{}, 300);
      msg.addEventListener('input', debouncedNoop);

      function renderMarkdownOrFallback(container, raw){
        const trimmed=(raw||'').trim();
        const c=container.querySelector('.content')||container;
        try{
          const html = DOMPurify.sanitize(marked.parse(trimmed));
          if (!html || html.replace(/\s/g,'')===''){
            c.textContent = trimmed || '[no response]';
          } else {
            c.innerHTML = html;
          }
        }catch{ c.textContent = trimmed || '[no response]'; }
      }

      async function doPost(text){
        try{
          const r = await fetch('/chat', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ message: text }) });
          const out = r.ok ? await r.text() : `[http ${r.status}]`;
          if (activeBotDiv){ activeBotDiv.dataset.raw=out; renderMarkdownOrFallback(activeBotDiv, out); }
        }catch{ if(activeBotDiv) activeBotDiv.textContent='[network error]'; }
        finally{ setBusy(false); }
      }

      let configCache = null;
      async function getConfig(){
        if (configCache) return configCache;
        try{
          const r = await fetch('/api/config');
          configCache = r.ok ? await r.json() : { ui: { sse_enabled: true, allow_basic_html: true } };
        }catch{
          configCache = { ui: { sse_enabled: true, allow_basic_html: true } };
        }
        return configCache;
      }

      async function send(){
        if (busy) return; const value=(msg.value||'').trim(); if(!value) return;
        append('user', value); msg.value='';
        activeBotDiv = append('bot',''); accumulated=''; setBusy(true);
        
        const config = await getConfig();
        const sseEnabled = config.ui.sse_enabled;
        
        if (!sseEnabled) {
          doPost(value);
          return;
        }
        
        const url = new URL('/events/stream', window.location.origin); url.searchParams.set('llm','1'); url.searchParams.set('message', value);
        try{
          const es = new EventSource(url.toString()); activeSSE=es;
          es.onmessage = (ev)=>{ accumulated += ev.data; if(activeBotDiv){ activeBotDiv.dataset.raw=accumulated; const c=activeBotDiv.querySelector('.content')||activeBotDiv; c.textContent = accumulated; chat.scrollTop=chat.scrollHeight; } };
          es.addEventListener('end', ()=>{ try{ es.close(); }catch{}; activeSSE=null; if(activeBotDiv){ renderMarkdownOrFallback(activeBotDiv, accumulated); } setBusy(false); });
          es.onerror = ()=>{ try{ es.close(); }catch{}; activeSSE=null; doPost(value); };
        }catch{ doPost(value); }
      }

      sendBtn.addEventListener('click', send);
      msg.addEventListener('keydown', (e)=>{ const isEnter=e.key==='Enter'; const isCtrl=e.ctrlKey||e.metaKey; if(isEnter&&isCtrl){ e.preventDefault(); send(); } });
    </script>
  </body>
</html>
