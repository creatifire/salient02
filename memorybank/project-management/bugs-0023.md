<!--
Copyright (c) 2025 Ape4, Inc. All rights reserved.
Unauthorized copying of this file is strictly prohibited.
-->

# Bug Report: Epic 0023 Directory Service

> **Last Updated**: January 12, 2025  
> **Epic**: [0023-directory-service.md](0023-directory-service.md)

## Summary

1. **BUG-0023-001** (P0): SQLAlchemy concurrent operations error during parallel tool execution ✅ **COMPLETE**
2. **BUG-0023-002** (P1): Configuration cascade looking in wrong path ✅ **COMPLETE**
3. **BUG-0023-003** (P2): Connection pool sizing insufficient for concurrent load ✅ **COMPLETE**

**Impact**: Parallel tool calls → cost tracking failures → lost billing data  
**Resolution**: Option B (Session-per-Operation) implemented and verified ✅

**Test Source**: `memorybank/analysis/llm-tool-calling-evaluation.md` lines 115-138

---

## BUG-0023-001: SQLAlchemy Concurrent Operations Error ✅ **COMPLETE**

### Problem

Parallel tool calls (2x `search_directory`) cause cost tracking to fail with "concurrent operations are not permitted". Results in `llm_request_id: None` and lost billing data.

**Evidence**:
```python
"Cost tracking failed: This session is provisioning a new connection; 
concurrent operations are not permitted"
# llm_request_id: None, response_length: 24 (normal: 4000+)
```

**Related Documentation**: See [SQLAlchemy Session-Per-Operation Pattern](../../analysis/critical-libraries-review.md#session-per-operation-pattern--critical) in Critical Libraries Review.

### Root Cause

Shared database session across concurrent operations:
1. LLM makes 2 parallel tool calls
2. Tools query database (session "provisioning")
3. Cost tracking tries to write concurrently
4. SQLAlchemy rejects: session mid-transaction

**Location**: `SessionDependencies.db_session` shared between tools and cost tracker

### Impact

- Lost billing data (unbilled LLM usage)
- Audit trail gaps
- Cannot analyze parallel tool performance

### Fix Options

#### Option A: Sequential Tool Execution

Force tools to run one-by-one. **Not recommended** - defeats parallel tool calling purpose.

**Trade-off**: 2.4s → 4.8s for 2 tools

---

#### Option B: Session-per-Operation ⭐ **Long-term Solution**

Each operation creates its own session. See **[bugs-0023-001-option-b-revised-plan.md](bugs-0023-001-option-b-revised-plan.md)** for full implementation.

**Core concept**:
```python
@agent.tool
async def search_directory(...):
    async with get_db_session() as session:  # Independent session
        return await directory_service.search(session, ...)

async def track_request(...):
    async with get_db_session() as session:  # Independent session
        session.add(llm_request)
        await session.commit()
```

**Pros**: Proper architecture, scalable, eliminates conflicts  
**Cons**: 2-3 days effort, requires testing across agents  
**Effort**: 2-3 days  
**Status**: ✅ **COMPLETE** - All phases implemented and verified (January 12, 2025)

---

#### Option C: Deferred Cost Tracking ⭐ **Quick Fix**

Track costs after tools complete, not during execution.

```python
async def simple_chat_stream(...):
    cost_data = {...}  # Store in memory
    
    # 1. Execute LLM (tools run in parallel)
    async for chunk in result.stream_text(delta=True):
        yield chunk
    
    # 2. After completion, write to database
    llm_request_id = await llm_request_tracker.track_request(**cost_data)
```

**Pros**: Minimal changes, preserves parallel execution  
**Cons**: Costs lost if crash mid-stream  
**Effort**: 2-4 hours

### Recommendation

- **Phase 1** (This Week): Implement Option C
- **Phase 2** (Next Quarter): Implement Option B - [See detailed plan](bugs-0023-001-option-b-revised-plan.md)

### Resolution ✅

**Option B implemented and verified** (January 12, 2025):
- ✅ SessionDependencies: `db_session` removed
- ✅ Tools: All tools create independent sessions via `get_db_session()`
- ✅ Cost Tracking: `LLMRequestTracker` creates own session
- ✅ Callers: Updated to use sessionless tracker initialization
- ✅ Verification: No remaining references to shared `db_session` in tools

**Result**: Concurrent operations error eliminated, parallel tool execution preserved, billing data tracked correctly.

---

## BUG-0023-002: Configuration Cascade Path Error ✅ **COMPLETE**

### Problem

Config loader uses wrong path: looks for `agent_configs/simple_chat/config.yaml` instead of `agent_configs/wyckoff/wyckoff_info_chat1/config.yaml`. All agents fall back to global config.

### Fix ✅

Update path construction in config loader to support multi-tenant pattern:

```python
# Before (wrong)
config_path = f"agent_configs/{agent_type}/config.yaml"

# After (correct)
if account_slug and instance_slug:
    config_path = f"agent_configs/{account_slug}/{instance_slug}/config.yaml"
else:
    config_path = f"agent_configs/{agent_type}/config.yaml"  # Legacy compatibility
```

**Implementation**:
- Updated `get_agent_parameter()` to accept optional `account_slug` and `instance_slug` parameters
- Uses `instance_loader._get_config_path()` for multi-tenant path construction
- Loads config directly from file when multi-tenant params provided
- Maintains backward compatibility with legacy agent_type-based paths
- Updated `get_agent_model_settings()` and `get_agent_tool_config()` to support multi-tenant paths

**Files**: `backend/app/agents/config_loader.py`  
**Effort**: 1-2 hours ✅ **COMPLETE**  
**Status**: ✅ **COMPLETE** - Manual testing passed (January 12, 2025)  
**Commit**: `74ed4f9`

---

## BUG-0023-003: Connection Pool Sizing ✅ **COMPLETE**

### Problem

`max_overflow=0` means no burst capacity. May exhaust pool under concurrent load.

**Related Documentation**: See [Connection Pool Configuration](../../analysis/critical-libraries-review.md#connection-pool-configuration-) in Critical Libraries Review.

### Fix ✅

```python
engine = create_async_engine(
    pool_size=20,
    max_overflow=10,      # Add burst capacity (total: 30)
    pool_pre_ping=True,   # Verify connections
)
```

**Implementation**:
- Updated `backend/config/app.yaml`: `max_overflow: 0` → `max_overflow: 10`
- Updated `backend/app/database.py`: Default `max_overflow=0` → `max_overflow=10`
- Updated `backend/app/config.py`: Validation defaults `0` → `10`
- Updated docstrings to reflect new default

**Before**: `pool_size=20`, `max_overflow=0` (total: 20 connections)  
**After**: `pool_size=20`, `max_overflow=10` (total: 30 connections)

**Files**: 
- `backend/config/app.yaml`
- `backend/app/database.py`
- `backend/app/config.py`

**Timeline**: After BUG-001 fixed, before production ✅ **COMPLETE**  
**Status**: ✅ **COMPLETE** - Configuration updated (January 12, 2025)  
**Commit**: `4de196e`

---

## Fix Priority

1. **BUG-001** (P0): ✅ **COMPLETE** - Option B implemented
2. **BUG-002** (P1): ✅ **COMPLETE** - Config path fixed (January 12, 2025)
3. **BUG-003** (P2): ✅ **COMPLETE** - Pool sizing fixed (January 12, 2025)

---

**Created**: 2025-10-29 | **Epic**: [0023-directory-service.md](0023-directory-service.md)
